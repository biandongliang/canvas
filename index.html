<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>联网双人抢金币</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
body { background:#222; color:white; text-align:center; font-family:Arial; }
canvas { background:#111; border:2px solid white; }
button, input { padding:8px; margin:5px; }
</style>
</head>
<body>

<h2>联网双人抢金币</h2>

<div id="menu">
<button onclick="createRoom()">创建房间</button>
<input id="roomInput" placeholder="输入房间ID">
<button onclick="joinRoom()">加入房间</button>
<p id="myId"></p>
</div>

<canvas id="game" width="600" height="400"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let peer = new Peer();
let conn;
let isHost = false;

let player = { x: 50, y: 200 };
let enemy = { x: 500, y: 200 };
let coin = spawnCoin();

function spawnCoin() {
    return {
        x: Math.random() * 580,
        y: Math.random() * 380
    };
}

peer.on("open", id => {
    document.getElementById("myId").innerText = "你的房间ID: " + id;
});

peer.on("connection", connection => {
    conn = connection;
    isHost = true;
    setupConnection();
});

function createRoom() {
    alert("把你的ID发给朋友");
}

function joinRoom() {
    const id = document.getElementById("roomInput").value;
    conn = peer.connect(id);
    setupConnection();
}

function setupConnection() {
    conn.on("data", data => {
        enemy = data.player;
        if (!isHost && data.coin) {
            coin = data.coin;
        }
    });
}

document.addEventListener("keydown", e => {
    const speed = 15;

    if (e.key === "w") player.y -= speed;
    if (e.key === "s") player.y += speed;
    if (e.key === "a") player.x -= speed;
    if (e.key === "d") player.x += speed;

    limit(player);

    if (conn && conn.open) {
        conn.send({
            player: player,
            coin: isHost ? coin : null
        });
    }

    checkCollision();
});

function limit(p) {
    p.x = Math.max(0, Math.min(570, p.x));
    p.y = Math.max(0, Math.min(370, p.y));
}

function checkCollision() {
    if (isColliding(player, coin)) {
        coin = spawnCoin();
    }
}

function isColliding(a, b) {
    return (
        a.x < b.x + 20 &&
        a.x + 30 > b.x &&
        a.y < b.y + 20 &&
        a.y + 30 > b.y
    );
}

function draw() {
    ctx.clearRect(0,0,600,400);

    ctx.fillStyle="gold";
    ctx.fillRect(coin.x, coin.y, 20,20);

    ctx.fillStyle="blue";
    ctx.fillRect(player.x, player.y, 30,30);

    ctx.fillStyle="red";
    ctx.fillRect(enemy.x, enemy.y, 30,30);

    requestAnimationFrame(draw);
}

draw();
</script>
</body>
</html>
